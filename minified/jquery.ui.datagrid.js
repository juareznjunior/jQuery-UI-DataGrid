/*!
 * jQuery UI datagrid
 * 
 * @autor:.....Juarez Gonçalves Nery Junior
 * @email:.....juareznjunior@gmail.com
 * @twitter:...@juareznjunior
 * 
 * Depends:
 *	 jquery.ui.core.js
 *	 jquery.ui.widget.js
 *	 jquery.ui.button.js
 */
(function(c,j){c.widget("ui.datagrid",{options:{limit:5,mapper:[],height:200,jsonStore:{params:{},url:"",data:{}},pagination:!0,toolBarButtons:!1,refresh:!1,onSelectRow:!1,onComplete:!1,onLoad:!1,rowHover:!0,rowClick:!0,rowNumber:!1,ajaxMethod:"POST",autoRender:!0,autoLoad:!0,title:"",classThead:"ui-state-default",containerBorder:!0,fit:!1},_create:function(){this.uiDataGrid=c(this._getMarkup());this.uiDataGridChilds=this.uiDataGrid.children();this.uiDataGridTables=this.uiDataGridChilds.find("table");
this.uiDataGridThead=c(this.uiDataGridTables[0].tHead);this.uiDataGridTheadBody=c(this.uiDataGridTables[1].tHead);this.uiDataGridTbody=c(this.uiDataGridTables[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||c.isArray(this.options.toolBarButtons)?c(this.uiDataGridTables[2].tBodies[0]):c([]);this.uiDataGridScroll=this.uiDataGridTables.eq(0).parent().next();this._totalPages=this._offset=0;this._selectedRows=[];this._tbodyEvents();delete this.uiDataGridTables;delete this.uiDataGridChilds},
_init:function(){this.options.autoRender&&this.render()},_setOption:function(a,b){c.Widget.prototype._setOption.apply(this,arguments)},_getMarkup:function(){var a=document.createElement("div"),b="";a.className="ui-data-grid-container ui-widget"+(this.options.containerBorder?" ui-widget-content ui-corner-all":"");a.style.cssText="padding:1px";this.options.title!==""&&(b+='<div style="text-align: center; padding: 0.4em 0pt" class="ui-widget-header ui-corner-all">'+this.options.title+"</div><div>");
b+='<div><table cellspacing="0" cellpadding="0" class="ui-datagrid" role="grid"><thead><tr role="rowheader"></tr></thead></table></div><div class="ui-widget-content" style="height:'+this.options.height+'px;overflow-y:scroll;overflow-x:hidden;border:0 !important"><table cellspacing="0" cellpadding="0" class="ui-datagrid ui-datagrid-tbody" role="grid"><thead><tr role="rowheader"></tr></thead><tbody></tbody></table></div>';if(this.options.pagination||c.isArray(this.options.toolBarButtons))b+='<div class="ui-data-grid-toolbar ui-widget ui-state-default ui-corner-all" style="margin-top:1px"><table cellspacing="0" cellpadding="0" style="width:100%;background:none"><tbody><tr style="background:none"><td style="padding:1px;text-align:left;border:none">&nbsp;</td>',
this.options.pagination&&(b+='<td style="text-align:right;padding:1px;border:0"><span style="margin-right:5px"></span></td>'),b+="</tr></tbody></table></div>";this.options.title!==""&&(b+="</div>");b+="</div>";a.innerHTML=b;return a},_createToolButtons:function(){var a=c(this.uiDataGridTfoot[0].rows[0].cells).eq(-1)[0];c.each(["first","prev","next","end"],function(b,e){c(j.createElement("button")).attr("name","data-grid-button-"+e).text(e).button({icons:{primary:"ui-icon-seek-"+e},text:!1}).appendTo(a)});
a=null;return this},_disableToolButtons:function(){c(this.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(":button").removeClass("ui-state-hover ui-state-focus").button("disable");return this},_createColumns:function(){var a="ui-widget "+this.options.classThead,b,e=[],d,f=0;for(d=0;d=this.options.mapper[f++];){b=document.createElement("th");b.className=a;if(f>1)b.style.borderLeftWidth="0";var g=void 0!==d.alias?d.alias:d.name,i=c(document.createElement("div")).addClass("ui-widget ui-state-default").css({overflow:"scroll",
position:"absolute",left:0}).html(g).appendTo(document.body);c(b).attr("role","gridcell")[0].innerHTML=g;c.isPlainObject(d.css)&&c(b).css(d.css);d=c(b).width();b.style.width=Math.max(d,i[0].scrollWidth)+"px";document.body.removeChild(i[0]);e[e.length]=b}c(e).last().width("auto");b=document.createElement("th");b.innerHtml="&nbsp";b.className=a;b.style.cssText="border-left-width:0;width:17px;padding:0";e[e.length]=b;if(this.options.rowNumber)b=document.createElement("th"),b.innerHTML="&nbsp",b.className=
a+" ui-datagrid-cell-rownumber",b.style.cssText="width:20px;border-right-width:0",e.splice(0,0,b);c(c([this.uiDataGridThead[0].rows[0],this.uiDataGridTheadBody[0].rows[0]]).append(e).last()[0].cells).last().css("background","none");r=null},_createRows:function(a){var b=this.getThead()[0].rows[0].cells;this.clear();this.uiDataGridScroll.scrollTop(0);for(var e,d,f,g=0,i=0;f=a.rows[g++];){e=document.createElement("tr");e.style.cssText=this.options.rowClick?"cursor:pointer":"cursor:default";e.className=
"ui-datagrid-row-"+(g%2?"odd":"even");if(this.options.rowNumber)d=document.createElement("td"),d.className=this.options.classThead,d.style.cssText="width:20px;text-align:center;vertical-align:middle;border-width:0 0 0 1px;padding:0",d.innerHTML=parseInt(this._offset)+g,e.appendChild(d);for(;_td=this.options.mapper[i++];){d=document.createElement("td");d.className="ui-widget ui-widget-content";e.appendChild(d);d.style.cssText="overflow:hidden;border-width:0 1px 0 1px;background:0;text-align:"+b[d.cellIndex].style.textAlign;
if(i>1)d.style.borderLeftWidth="0";void 0!=_td.css&&_td.css.hasOwnProperty("textAlign")&&c(d).css("textAlign",_td.css.textAlign);d.style.width=c(b[d.cellIndex]).width()+"px";d.innerHTML=c.isFunction(_td.map)?_td.map(f[_td.name]):c.isFunction(window[_td.globalFunction])?window[_td.globalFunction](f[_td.name]):f[_td.name]}e.appendChild(document.createElement("th"));this.uiDataGridTbody[0].appendChild(e);i=0}c(this.uiDataGridTbody[0].rows).last().children().css("border-bottom-width","1px");y=0},_ajax:function(){var a=
this;a.options.jsonStore.url!=""?("string"===typeof a.options.jsonStore.params?a.options.jsonStore.params=0===a._offset?a.options.jsonStore.params+"&limit="+a.options.limit+"&offset="+a._offset:a.options.jsonStore.params.replace(/(&offset=)(.+)/,"&offset="+a._offset):(a.options.jsonStore.params.limit=a.options.limit,a.options.jsonStore.params.offset=a._offset),a.options.pagination&&a._disableToolButtons(),c.ajax({type:a.options.ajaxMethod.toLowerCase(),url:a.options.jsonStore.url.replace(/\?.*/,""),
data:a.options.jsonStore.params,dataType:"json",success:function(b){if(void 0!==b.error)return alert(b.error),!1;if(void 0===b.numRows||b.numRows==0)return!1;if(a.options.pagination){a._totalPages=Math.ceil(b.numRows/a.options.limit);var e=a._offset==0?1:a._offset/a.options.limit+1,d=e+" de "+a._totalPages+" ("+b.numRows+")";c.each(c(a.uiDataGridTfoot[0].rows[0].cells).eq(-1).children(),function(){/span/i.test(this.tagName)?this.innerHTML=d:/data-grid-button-(first|prev)/.test(this.name)?a._offset>
0&&this.disabled&&c(this).button("enable"):a._totalPages>e&&this.disabled&&c(this).button("enable")})}a._createRows(b)}})):a._createRows(a.options.jsonStore.data);c.isFunction(a.options.onLoad)&&a.options.onLoad()},render:function(){var a=this;if(a.element.children("div:first").hasClass("ui-data-grid-container"))a.resetOffset(),a.load();else{c.isArray(a.options.toolBarButtons)&&c.each(a.options.toolBarButtons,function(b,d){(function(){this.innerHTML=d.label;c.isFunction(d.fn)&&c(this).bind("click",
function(){d.fn.call(this,a.element);c(this).blur()});c(this).button({icons:{primary:void 0===d.icon?null:"ui-icon-"+d.icon}});a.uiDataGridTfoot[0].rows[0].cells[0].appendChild(this)}).call(document.createElement("button"))});a.uiDataGrid.appendTo(a.element);a._createColumns();var b=a.uiDataGrid.width();h=a.uiDataGridThead.outerHeight();a.uiDataGridScroll.width(b);a.uiDataGridTheadBody.parent().width(b).css("marginTop",-h);b=h=null;a.options.pagination&&(a._createToolButtons()._disableToolButtons(),
c(a.uiDataGridTfoot[0].rows[0].cells).eq(-1).delegate("button","click",function(){if(!this.disabled)a[this.name.replace(/data-grid-button-/,"")+"Page"](),a._selectedRows=[],a.load()}));a.resize();a.options.autoLoad&&a.load();c.isFunction(a.options.onComplete)&&a.options.onComplete.call(a.uiDataGridTbody[0])}return this},nextPage:function(){this._offset+=this.options.limit},prevPage:function(){this._offset-=this.options.limit},endPage:function(){this._offset=this._totalPages*this.options.limit-this.options.limit},
firstPage:function(){this._offset=0},_tbodyEvents:function(){var a=this,b=[];this.options.rowHover&&(b[b.length]="mouseover",b[b.length]="mouseout");this.options.rowClick&&(b[b.length]="click");b.length>0&&a.uiDataGridTbody.undelegate().delegate("tr",b.join(" "),function(b){"click"===b.type?a._clickRow(this,b):c(this)["mouseover"===b.type?"addClass":"removeClass"]("ui-state-hover")});b=null},_clickRow:function(a){if(c(a).hasClass("ui-state-highlight")){c(a).removeClass("ui-state-highlight");for(var b=
0,e;e=this._selectedRows[b++];)if(a===e){this._selectedRows.splice(--b,1);break}}else c(a).addClass("ui-state-highlight"),this._selectedRows[this._selectedRows.length]=a,c.isFunction(this.options.onSelectRow)&&this.options.onSelectRow.call(a,[this.element[0]])},resize:function(){var a=this;a.options.fit&&function(){var b=a.uiDataGrid.outerHeight()-a.element.height();this.height(this.height()-b+"px")}.call(a.uiDataGridScroll);a=null;return this},getSelectedRows:function(){return this._selectedRows},
clearSelectedRows:function(){for(var a=0,b;b=this._selectedRows[a++];)c(b).removeClass("ui-state-highlight");this._selectedRows=[]},load:function(){this._ajax();return this},widget:function(){return this.uiDataGrid},destroy:function(){c.Widget.prototype.destroy.call(this);this.element.empty()},getOffset:function(){return this._offset},resetOffset:function(){this._offset=0},getThead:function(a){return c.isFunction(a)?a.call(this.uiDataGridThead[0]):this.uiDataGridThead},getTbody:function(a){return c.isFunction(a)?
a.call(this.uiDataGridTbody[0]):this.uiDataGridTbody},getTFoot:function(a){return c.isFunction(a)?a.call(this.uiDataGridTfoot[0]):this.uiDataGridTfoot},clear:function(){this.uiDataGridTbody.empty()}})})(jQuery,document);
